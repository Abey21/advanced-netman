hostname {{ device.name }}

username admin privilege 15 role network-admin secret {{ device.admin_secret | default('admin') }}

management api http-commands
   no shutdown
management api gnmi
   transport grpc default
management api netconf
   transport ssh default

snmp-server community public ro
{% if device.snmp_host %}snmp-server host {{ device.snmp_host }} version 2c public{% endif %}

{% for vlan in device.vlans %}
vlan {{ vlan.id }}
   name {{ vlan.name }}
{% endfor %}

{% for interface in device.interfaces %}
interface {{ interface.name }}
{% if interface.switchport_mode %}   switchport mode {{ interface.switchport_mode }}
{% else %}   no switchport{% endif %}
{% if interface.ipv4 %}   ip address {{ interface.ipv4 }}{% endif %}
{% if interface.ipv6 %}   ipv6 address {{ interface.ipv6 }}{% endif %}
{% if interface.ospfv3_area %}   ospfv3 ipv6 area {{ interface.ospfv3_area }}{% endif %}
{% endfor %}

{% for vlan in device.vlans %}
interface Vlan{{ vlan.id }}
{% if vlan.mtu %}   mtu {{ vlan.mtu }}{% endif %}
{% if vlan.ipv4_subnet %}   ip address {{ vlan.ipv4_subnet }}{% endif %}
{% if vlan.ipv6_subnet %}   ipv6 enable
   ipv6 address {{ vlan.ipv6_subnet }}{% endif %}
{% if vlan.ospfv3 and vlan.ospfv3.area is not none %}   ospfv3 ipv6 area {{ vlan.ospfv3.area }}{% endif %}
!
{% endfor %}

ip routing
ipv6 unicast-routing

{% for route in device.routes.static %}ip route {{ route.prefix }} {{ route.next_hop }}
{% endfor %}
{% for route in device.routes.ipv6_static %}ipv6 route {{ route.prefix }} {{ route.next_hop }}
{% endfor %}

{% if device.routing_protocols.ospf %}
router ospf {{ device.routing_protocols.ospf.id }}
{% if device.routing_protocols.ospf.router_id %}   router-id {{ device.routing_protocols.ospf.router_id }}{% endif %}
{% for n in device.routing_protocols.ospf.networks %}   network {{ n.prefix | ospf_net }} area {{ n.area }}
{% endfor %}   max-lsa 12000
{% endif %}

router ospfv3
   address-family ipv6
   {% if device.routing_protocols.ospfv3 and device.routing_protocols.ospfv3.redistribute_bgp %}redistribute bgp{% endif %}

{% if device.routing_protocols.bgp and device.routing_protocols.bgp.as %}
router bgp {{ device.routing_protocols.bgp.as }}
{% if device.routing_protocols.bgp.router_id %}   bgp router-id {{ device.routing_protocols.bgp.router_id }}{% endif %}
{% for nei in device.routing_protocols.bgp.neighbors %}
   neighbor {{ nei.ip }} remote-as {{ nei.remote_as }}
{% if nei.update_source %}   neighbor {{ nei.ip }} update-source {{ nei.update_source }}{% endif %}
{% if nei.password %}   neighbor {{ nei.ip }} password {{ nei.password }}{% endif %}
{% if nei.ebgp_multihop %}   neighbor {{ nei.ip }} ebgp-multihop {{ nei.ebgp_multihop }}{% endif %}
{% endfor %}
   redistribute connected
{% if device.routing_protocols.ospf %}   redistribute ospf{% endif %}
{% if device.routing_protocols.ospfv3 %}   redistribute ospfv3{% endif %}
   !
   address-family ipv4
{% for net in device.routing_protocols.bgp.networks %}      network {{ net }}
{% endfor %}
   !
   address-family ipv6
{% for nei in device.routing_protocols.bgp.neighbors %}{% if '::' in nei.ip %}
      neighbor {{ nei.ip }} activate
{% endif %}{% endfor %}
{% endif %}
end
